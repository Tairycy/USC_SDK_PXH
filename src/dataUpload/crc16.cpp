#include <limits.h>

static unsigned short crc16_table[256] = {
	0X0000U, 0X1021U, 0X2042U, 0X3063U, 0X4084U, 0X50A5U, 0X60C6U, 0X70E7U,
	0X8108U, 0X9129U, 0XA14AU, 0XB16BU, 0XC18CU, 0XD1ADU, 0XE1CEU, 0XF1EFU,
	0X1231U, 0X0210U, 0X3273U, 0X2252U, 0X52B5U, 0X4294U, 0X72F7U, 0X62D6U,
	0X9339U, 0X8318U, 0XB37BU, 0XA35AU, 0XD3BDU, 0XC39CU, 0XF3FFU, 0XE3DEU,
	0X2462U, 0X3443U, 0X0420U, 0X1401U, 0X64E6U, 0X74C7U, 0X44A4U, 0X5485U,
	0XA56AU, 0XB54BU, 0X8528U, 0X9509U, 0XE5EEU, 0XF5CFU, 0XC5ACU, 0XD58DU,
	0X3653U, 0X2672U, 0X1611U, 0X0630U, 0X76D7U, 0X66F6U, 0X5695U, 0X46B4U,
	0XB75BU, 0XA77AU, 0X9719U, 0X8738U, 0XF7DFU, 0XE7FEU, 0XD79DU, 0XC7BCU,
	0X48C4U, 0X58E5U, 0X6886U, 0X78A7U, 0X0840U, 0X1861U, 0X2802U, 0X3823U,
	0XC9CCU, 0XD9EDU, 0XE98EU, 0XF9AFU, 0X8948U, 0X9969U, 0XA90AU, 0XB92BU,
	0X5AF5U, 0X4AD4U, 0X7AB7U, 0X6A96U, 0X1A71U, 0X0A50U, 0X3A33U, 0X2A12U,
	0XDBFDU, 0XCBDCU, 0XFBBFU, 0XEB9EU, 0X9B79U, 0X8B58U, 0XBB3BU, 0XAB1AU,
	0X6CA6U, 0X7C87U, 0X4CE4U, 0X5CC5U, 0X2C22U, 0X3C03U, 0X0C60U, 0X1C41U,
	0XEDAEU, 0XFD8FU, 0XCDECU, 0XDDCDU, 0XAD2AU, 0XBD0BU, 0X8D68U, 0X9D49U,
	0X7E97U, 0X6EB6U, 0X5ED5U, 0X4EF4U, 0X3E13U, 0X2E32U, 0X1E51U, 0X0E70U,
	0XFF9FU, 0XEFBEU, 0XDFDDU, 0XCFFCU, 0XBF1BU, 0XAF3AU, 0X9F59U, 0X8F78U,
	0X9188U, 0X81A9U, 0XB1CAU, 0XA1EBU, 0XD10CU, 0XC12DU, 0XF14EU, 0XE16FU,
	0X1080U, 0X00A1U, 0X30C2U, 0X20E3U, 0X5004U, 0X4025U, 0X7046U, 0X6067U,
	0X83B9U, 0X9398U, 0XA3FBU, 0XB3DAU, 0XC33DU, 0XD31CU, 0XE37FU, 0XF35EU,
	0X02B1U, 0X1290U, 0X22F3U, 0X32D2U, 0X4235U, 0X5214U, 0X6277U, 0X7256U,
	0XB5EAU, 0XA5CBU, 0X95A8U, 0X8589U, 0XF56EU, 0XE54FU, 0XD52CU, 0XC50DU,
	0X34E2U, 0X24C3U, 0X14A0U, 0X0481U, 0X7466U, 0X6447U, 0X5424U, 0X4405U,
	0XA7DBU, 0XB7FAU, 0X8799U, 0X97B8U, 0XE75FU, 0XF77EU, 0XC71DU, 0XD73CU,
	0X26D3U, 0X36F2U, 0X0691U, 0X16B0U, 0X6657U, 0X7676U, 0X4615U, 0X5634U,
	0XD94CU, 0XC96DU, 0XF90EU, 0XE92FU, 0X99C8U, 0X89E9U, 0XB98AU, 0XA9ABU,
	0X5844U, 0X4865U, 0X7806U, 0X6827U, 0X18C0U, 0X08E1U, 0X3882U, 0X28A3U,
	0XCB7DU, 0XDB5CU, 0XEB3FU, 0XFB1EU, 0X8BF9U, 0X9BD8U, 0XABBBU, 0XBB9AU,
	0X4A75U, 0X5A54U, 0X6A37U, 0X7A16U, 0X0AF1U, 0X1AD0U, 0X2AB3U, 0X3A92U,
	0XFD2EU, 0XED0FU, 0XDD6CU, 0XCD4DU, 0XBDAAU, 0XAD8BU, 0X9DE8U, 0X8DC9U,
	0X7C26U, 0X6C07U, 0X5C64U, 0X4C45U, 0X3CA2U, 0X2C83U, 0X1CE0U, 0X0CC1U,
	0XEF1FU, 0XFF3EU, 0XCF5DU, 0XDF7CU, 0XAF9BU, 0XBFBAU, 0X8FD9U, 0X9FF8U,
	0X6E17U, 0X7E36U, 0X4E55U, 0X5E74U, 0X2E93U, 0X3EB2U, 0X0ED1U, 0X1EF0U
};

const unsigned int CRC16_NORM = USHRT_MAX/32 + 1;

unsigned short crc16(unsigned char* buf, int size)
{
	unsigned short crc = 0;
	unsigned char *p = (unsigned char *)buf;

	while (size--) {
		crc = crc16_table[(crc >> 8 ^ *(p++)) & 0xFFU] ^ (crc << 8);
	}

	return crc;
}

char crc16_base_char(unsigned char* data, int len) {

    const static char BASE32_TABLE[] = "abcdefghijklmnopqrstuvwxyz234567a";

    unsigned short crc = crc16(data, len);
    crc /= CRC16_NORM;

    return BASE32_TABLE[crc];
}


